{"version":3,"file":"aiService-BKnG4cQx-BKnG4cQx.js","sources":["../../src/services/aiService.ts"],"sourcesContent":["/**\n * AI 服务层 - 封装大模型 API 调用\n * 支持 DeepSeek、智谱GLM、通义千问等国内大模型\n * 自动降级策略：DeepSeek -> 智谱GLM -> 通义千问\n */\n\nexport interface ChatMessage {\n  role: 'system' | 'user' | 'assistant'\n  content: string\n}\n\nexport interface ChatOptions {\n  messages: ChatMessage[]\n  temperature?: number\n  maxTokens?: number\n  stream?: boolean\n  onStream?: (chunk: string) => void\n}\n\nexport interface ChatResponse {\n  content: string\n  usage?: {\n    promptTokens: number\n    completionTokens: number\n    totalTokens: number\n  }\n}\n\n// 提供商类型\ntype Provider = 'deepseek' | 'zhipu' | 'qwen'\n\n// API 配置\nconst CONFIG = {\n  deepseek: {\n    key: import.meta.env.VITE_DEEPSEEK_API_KEY || '',\n    url: import.meta.env.VITE_DEEPSEEK_API_URL || 'https://api.deepseek.com/v1',\n    model: 'deepseek-chat',\n  },\n  zhipu: {\n    key: import.meta.env.VITE_ZHIPU_API_KEY || '',\n    url: 'https://open.bigmodel.cn/api/paas/v4',\n    model: 'glm-4-flash',\n  },\n  qwen: {\n    key: import.meta.env.VITE_QWEN_API_KEY || '',\n    url: 'https://dashscope.aliyuncs.com/api/v1',\n    model: 'qwen-turbo',\n  },\n}\n\n/**\n * 获取可用的提供商列表（按优先级排序）\n */\nfunction getAvailableProviders(): Provider[] {\n  const providers: Provider[] = []\n  \n  if (CONFIG.deepseek.key && CONFIG.deepseek.key !== 'your_deepseek_api_key_here') {\n    providers.push('deepseek')\n  }\n  if (CONFIG.zhipu.key && CONFIG.zhipu.key !== 'your_zhipu_api_key_here') {\n    providers.push('zhipu')\n  }\n  if (CONFIG.qwen.key && CONFIG.qwen.key !== 'your_qwen_api_key_here') {\n    providers.push('qwen')\n  }\n  \n  return providers\n}\n\n/**\n * 构建请求头\n */\nfunction buildHeaders(provider: Provider): HeadersInit {\n  const headers: HeadersInit = {\n    'Content-Type': 'application/json',\n  }\n  \n  switch (provider) {\n    case 'deepseek':\n      headers['Authorization'] = `Bearer ${CONFIG.deepseek.key}`\n      break\n    case 'zhipu':\n      headers['Authorization'] = `Bearer ${CONFIG.zhipu.key}`\n      break\n    case 'qwen':\n      headers['Authorization'] = `Bearer ${CONFIG.qwen.key}`\n      break\n  }\n  \n  return headers\n}\n\n/**\n * 构建请求体\n */\nfunction buildBody(provider: Provider, options: ChatOptions): object {\n  const { messages, temperature = 0.7, maxTokens = 2000 } = options\n  \n  switch (provider) {\n    case 'deepseek':\n      return {\n        model: CONFIG.deepseek.model,\n        messages,\n        temperature,\n        max_tokens: maxTokens,\n        stream: options.stream,\n      }\n    case 'zhipu':\n      return {\n        model: CONFIG.zhipu.model,\n        messages,\n        temperature,\n        max_tokens: maxTokens,\n        stream: options.stream,\n      }\n    case 'qwen':\n      return {\n        model: CONFIG.qwen.model,\n        input: {\n          messages,\n        },\n        parameters: {\n          temperature,\n          max_tokens: maxTokens,\n          result_format: 'message',\n        },\n      }\n    default:\n      throw new Error(`未知的提供商: ${provider}`)\n  }\n}\n\n/**\n * 解析响应\n */\nfunction parseResponse(provider: Provider, data: any): ChatResponse {\n  switch (provider) {\n    case 'deepseek':\n    case 'zhipu':\n      return {\n        content: data.choices[0]?.message?.content || '',\n        usage: data.usage ? {\n          promptTokens: data.usage.prompt_tokens,\n          completionTokens: data.usage.completion_tokens,\n          totalTokens: data.usage.total_tokens,\n        } : undefined,\n      }\n    case 'qwen':\n      return {\n        content: data.output?.choices[0]?.message?.content || '',\n        usage: data.usage ? {\n          promptTokens: data.usage.input_tokens,\n          completionTokens: data.usage.output_tokens,\n          totalTokens: data.usage.total_tokens,\n        } : undefined,\n      }\n    default:\n      throw new Error(`未知的提供商: ${provider}`)\n  }\n}\n\n/**\n * 解析流式响应\n */\nfunction parseStreamChunk(provider: Provider, data: any): string | null {\n  switch (provider) {\n    case 'deepseek':\n    case 'zhipu':\n      return data.choices[0]?.delta?.content || null\n    case 'qwen':\n      return data.output?.choices[0]?.message?.content || null\n    default:\n      return null\n  }\n}\n\n/**\n * 非流式聊天请求（带自动降级）\n */\nexport async function chat(options: ChatOptions): Promise<ChatResponse> {\n  const providers = getAvailableProviders()\n  \n  if (providers.length === 0) {\n    throw new Error('未配置任何 AI API Key，请在 .env.local 中配置至少一个提供商（DeepSeek、智谱GLM 或 通义千问）')\n  }\n  \n  let lastError: Error | null = null\n  \n  for (const provider of providers) {\n    try {\n      console.log(`尝试使用 ${provider} API...`)\n      \n      const response = await fetch(`${CONFIG[provider].url}/chat/completions`, {\n        method: 'POST',\n        headers: buildHeaders(provider),\n        body: JSON.stringify(buildBody(provider, { ...options, stream: false })),\n      })\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        const errorMessage = errorData.error?.message || errorData.message || `HTTP ${response.status}`\n        \n        if (errorMessage.includes('Insufficient Balance') || \n            errorMessage.includes('余额不足') ||\n            response.status === 429) {\n          console.warn(`${provider} API 余额不足或限流，尝试下一个提供商...`)\n          lastError = new Error(`${provider}: ${errorMessage}`)\n          continue\n        }\n        \n        throw new Error(errorMessage)\n      }\n      \n      const data = await response.json()\n      console.log(`${provider} API 调用成功`)\n      return parseResponse(provider, data)\n      \n    } catch (error) {\n      console.error(`${provider} API 调用失败:`, error)\n      lastError = error instanceof Error ? error : new Error(String(error))\n      continue\n    }\n  }\n  \n  throw lastError || new Error('所有 AI 提供商都不可用')\n}\n\n/**\n * 流式聊天请求（带自动降级）\n */\nexport async function chatStream(options: ChatOptions): Promise<void> {\n  const { onStream } = options\n  \n  if (!onStream) {\n    throw new Error('流式请求必须提供 onStream 回调函数')\n  }\n  \n  const providers = getAvailableProviders()\n  \n  if (providers.length === 0) {\n    throw new Error('未配置任何 AI API Key，请在 .env.local 中配置至少一个提供商（DeepSeek、智谱GLM 或 通义千问）')\n  }\n  \n  let lastError: Error | null = null\n  \n  for (const provider of providers) {\n    try {\n      console.log(`尝试使用 ${provider} API (流式)...`)\n      \n      const response = await fetch(`${CONFIG[provider].url}/chat/completions`, {\n        method: 'POST',\n        headers: buildHeaders(provider),\n        body: JSON.stringify(buildBody(provider, { ...options, stream: true })),\n      })\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}))\n        const errorMessage = errorData.error?.message || errorData.message || `HTTP ${response.status}`\n        \n        if (errorMessage.includes('Insufficient Balance') || \n            errorMessage.includes('余额不足') ||\n            response.status === 429) {\n          console.warn(`${provider} API 余额不足或限流，尝试下一个提供商...`)\n          lastError = new Error(`${provider}: ${errorMessage}`)\n          continue\n        }\n        \n        throw new Error(errorMessage)\n      }\n      \n      const reader = response.body?.getReader()\n      if (!reader) {\n        throw new Error('无法获取响应流')\n      }\n      \n      const decoder = new TextDecoder()\n      let buffer = ''\n      \n      while (true) {\n        const { done, value } = await reader.read()\n        if (done) break\n        \n        buffer += decoder.decode(value, { stream: true })\n        const lines = buffer.split('\\n')\n        buffer = lines.pop() || ''\n        \n        for (const line of lines) {\n          if (line.trim() === '' || line.trim() === 'data: [DONE]') continue\n          \n          if (line.startsWith('data: ')) {\n            try {\n              const data = JSON.parse(line.slice(6))\n              const content = parseStreamChunk(provider, data)\n              if (content) {\n                onStream(content)\n              }\n            } catch (e) {\n              // 忽略解析错误\n            }\n          }\n        }\n      }\n      \n      console.log(`${provider} API 流式调用成功`)\n      return\n      \n    } catch (error) {\n      console.error(`${provider} API 流式调用失败:`, error)\n      lastError = error instanceof Error ? error : new Error(String(error))\n      continue\n    }\n  }\n  \n  throw lastError || new Error('所有 AI 提供商都不可用')\n}\n\n/**\n * 检查 API 配置是否有效\n */\nexport function isAIConfigured(): boolean {\n  return getAvailableProviders().length > 0\n}\n\n/**\n * 获取当前使用的提供商\n */\nexport function getCurrentProvider(): Provider | null {\n  const providers = getAvailableProviders()\n  return providers.length > 0 ? providers[0] : null\n}\n\n/**\n * 获取系统提示词 - 用于文章相关的 AI 助手\n */\nexport function getArticleSystemPrompt(articleTitle: string, articleContent: string): string {\n  return `你是 Levy 的技术博客 AI 助手，专门帮助读者理解技术文章。\n\n当前文章标题：${articleTitle}\n\n文章内容概要：\n${articleContent.slice(0, 2000)}...\n\n你的职责：\n1. 回答读者关于这篇文章的技术问题\n2. 解释文章中的复杂概念\n3. 提供与文章相关的扩展知识\n4. 帮助读者更好地理解和应用文章内容\n\n回答要求：\n- 使用中文回答\n- 回答要简洁明了，避免过于冗长\n- 如果问题与文章无关，礼貌地引导用户回到文章主题\n- 对于代码相关问题，可以提供示例代码\n- 如果不确定答案，诚实告知而不是编造`\n}\n\n/**\n * 获取文章总结提示词\n */\nexport function getSummarySystemPrompt(): string {\n  return `你是一位专业的技术文章分析助手。请对给定的技术文章进行总结。\n\n请按以下格式输出：\n1. 一句话概括文章核心内容\n2. 3-5 个关键要点（用简洁的 bullet points）\n3. 文章适合什么水平的读者阅读\n\n要求：\n- 总结要准确、简洁\n- 关键要点要覆盖文章的主要技术点\n- 使用中文输出\n- 不要添加与文章内容无关的信息`\n}\n"],"names":["CONFIG","getAvailableProviders","providers","buildHeaders","provider","headers","buildBody","options","messages","temperature","maxTokens","parseResponse","data","_a","_b","_c","_d","_e","parseStreamChunk","chat","lastError","response","errorData","errorMessage","error","chatStream","onStream","reader","decoder","buffer","done","value","lines","line","content","isAIConfigured","getArticleSystemPrompt","articleTitle","articleContent","getSummarySystemPrompt"],"mappings":"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"}